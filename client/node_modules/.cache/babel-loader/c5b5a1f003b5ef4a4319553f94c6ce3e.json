{"ast":null,"code":"var _jsxFileName = \"/Users/krispol/Desktop/invoice/invoice-with-session/client/src/pages/company/companyInvoice/NewInvoice.js\";\nimport React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport { withRouter } from 'react-router-dom';\nimport { connect } from 'react-redux';\nimport { setInvoiceInitState } from '../../../redux/actions/invoice';\nimport { updateCompanyArr } from '../../../redux/actions/companies';\nimport InvoiceDoc from './invoiceDoc/InvoiceDoc';\nimport NewInvoiceSubmit from './NewInvoiceSubmit';\nimport { alertUnsavedChanges } from '../../../components/form/utils/handleUnsavedChanges';\nimport { getInputValueByLabel } from '../../../components/form/utils/customFormQueries';\nimport { date_YYYY_MM, date_DD_MM_YYYY } from '../../../components/calendar/dates';\nimport { v4 as uuidv4 } from 'uuid';\n\nclass NewInvoice extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      invoice: null\n    };\n    this.handleChanges = this.handleChanges.bind(this);\n    this.resestInvoiceState = this.resestInvoiceState.bind(this);\n  }\n\n  resestInvoiceState() {\n    const invoive_init_state = {\n      _id: null,\n      created_at: new Date(),\n      saved_as,\n      issue_date: date_DD_MM_YYYY(new Date()),\n      due_date,\n      bg_color: localStorage.invoice_bg || 'blue',\n      text_color: localStorage.invoice_txt || 'white',\n      profile: JSON.parse(JSON.stringify(this.props.profile.details)),\n      company: JSON.parse(JSON.stringify(this.props.company.details)),\n      tasks: [],\n      discount: 0,\n      tax: 0,\n      fees: 0,\n      notes: 'Thank you for your business.',\n      currency: ''\n    }; //on submit clear app updates\n    // this.props.setUpdates(null);\n  }\n\n  componentDidMount() {\n    //set current tabs for handling unsaved changes redirection\n    this.setState({ ...this.state,\n      tabs: window.location.search\n    });\n    let invoiceInitState;\n\n    if (this.props.session.newInvoiceLoaded) {\n      //set all tasks to be excluded from invoice on load of a new invoice\n      const noTasksIncluded = this.props.company.tasks.map(t => t.addToInvoice = false);\n      updateCompanyArr('tasks', noTasksIncluded, this.props.company._id); //invoice num #\n\n      let company_abbr = getInputValueByLabel(this.props.company.details, 'Name').split(' ');\n\n      if (company_abbr.length > 1 && company_abbr[1]) {\n        company_abbr = company_abbr.map(el => el[0].toUpperCase()).join('');\n      } else {\n        company_abbr = company_abbr[0].slice(0, 3).toUpperCase();\n      }\n\n      let invoices_num = '1';\n      if (this.props.company.invoices) invoices_num = String(this.props.company.invoices.length + 1);\n\n      while (invoices_num.length < 5) {\n        invoices_num = '0' + invoices_num;\n      }\n\n      let saved_as = company_abbr + '-';\n      saved_as += date_YYYY_MM(new Date()) + '-';\n      saved_as += invoices_num; //generate due date in 14 days\n\n      const TWO_WEEKS = 1.21e9;\n      let due_date = date_DD_MM_YYYY(new Date().getTime() + TWO_WEEKS); //a new invoice\n\n      invoiceInitState = {\n        _id: uuidv4(),\n        created_at: new Date(),\n        saved_as,\n        issue_date: date_DD_MM_YYYY(new Date()),\n        due_date,\n        bg_color: localStorage.invoice_bg || 'blue',\n        text_color: localStorage.invoice_txt || 'white',\n        profile: JSON.parse(JSON.stringify(this.props.profile.details)),\n        company: JSON.parse(JSON.stringify(this.props.company.details)),\n        tasks: [],\n        discount: 0,\n        tax: 0,\n        fees: 0,\n        notes: 'Thank you for your business.',\n        currency: ''\n      }; //set init state for comparison on component unmounting\n\n      this.setState({\n        invoice: JSON.parse(JSON.stringify(invoiceInitState))\n      }); //set redux state\n\n      this.props.setInvoiceInitState(invoiceInitState);\n    }\n\n    const searchArr = window.location.search.split('&');\n\n    if (searchArr[1]) {\n      //updating an existing invoice\n      //?updating=...\n      //downlaoding an existing invoice\n      //?download=...\n      const invoice_ID = searchArr[1].slice(9);\n      const invoiceToLoad = this.props.company.invoices.find(invoice => invoice._id === invoice_ID);\n\n      if (invoiceToLoad) {\n        //invoiceInitState from the invoices arr\n        invoiceInitState = invoiceToLoad; //add invoice tasks to existing tasks of the current company\n\n        const tasksArrIncInvoiceTasks = [...invoiceToLoad.tasks, ...this.props.company.tasks];\n        this.props.updateCompanyArr('tasks', tasksArrIncInvoiceTasks, this.props.company._id);\n      }\n    }\n  }\n\n  componentWillUnmount() {\n    //auth err and logout won't trigger fun\n    if (this.props.session.authenticated) this.handleChanges();\n  }\n\n  handleChanges() {\n    //TASKS CAN BE AMENDED/UPDATED IN FORM  WITH EFECT ON DB HENCE NEED TO CHECK INIT STATE AGAINST COMPANY.TASKS NOT INVOICE.TASKS!!!\n    console.log(JSON.stringify(this.state.invoice) === JSON.stringify(this.props.invoice));\n    this.props.invoice.tasks = this.props.company.tasks.filter(t => t.addToInvoice);\n    console.log(this.state.invoice, this.props.invoice);\n    alertUnsavedChanges(this.state.invoice, this.props.invoice, `/dashboard/companies/${this.props.company._id}${this.state.tabs}`, null, this.props.history); // if (\n    //     JSON.stringify(this.state.invoice) !==\n    //     JSON.stringify(this.props.invoice)\n    // ) {\n    //     const msg = `You have some unsaved changes. What would you like to do?`;\n    //     const cancelBtnText = 'Discharge changes';\n    //     const confirmBtnText = 'Return to the form!';\n    //     const confirmCb = () => {};\n    //     const cancelCb = async () => {};\n    //     dialogBox({\n    //         msg,\n    //         cancelBtnText,\n    //         confirmBtnText,\n    //         confirmCb,\n    //         cancelCb,\n    //     });\n    // } else {\n    //     //remove any tasks added on update\n    //     const tasksWithoutInvocieTasks = this.props.company.tasks.filter(\n    //         (el) => !this.state.invoice.tasks.includes(el)\n    //     );\n    //     console.log(tasksWithoutInvocieTasks);\n    //     this.props.updateCompanyArr(\n    //         'tasks',\n    //         tasksWithoutInvocieTasks,\n    //         this.props.company._id\n    //     );\n    // }\n  }\n\n  render() {\n    return /*#__PURE__*/React.createElement(\"section\", {\n      className: \"company-invoice\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 188,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(\"h2\", {\n      className: \"sr-only\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 189,\n        columnNumber: 17\n      }\n    }, \"Create a new invoice.\"), /*#__PURE__*/React.createElement(InvoiceDoc, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 190,\n        columnNumber: 17\n      }\n    }), /*#__PURE__*/React.createElement(NewInvoiceSubmit, {\n      invoiceInitState: this.state.invoice,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 191,\n        columnNumber: 17\n      }\n    }));\n  }\n\n}\n\nNewInvoice.propTypes = {\n  session: PropTypes.object,\n  profile: PropTypes.object,\n  company: PropTypes.object,\n  invoice: PropTypes.object,\n  updateCompanyArr: PropTypes.func\n};\n\nconst mapStateToProps = state => ({\n  session: state.session,\n  profile: state.profile,\n  company: state.companies.find(c => c._id === state.session.currentCompany),\n  invoice: state.invoice\n});\n\nconst mapDispatchToProps = {\n  setInvoiceInitState,\n  updateCompanyArr\n};\nexport default connect(mapStateToProps, mapDispatchToProps)(withRouter(NewInvoice));","map":{"version":3,"sources":["/Users/krispol/Desktop/invoice/invoice-with-session/client/src/pages/company/companyInvoice/NewInvoice.js"],"names":["React","Component","PropTypes","withRouter","connect","setInvoiceInitState","updateCompanyArr","InvoiceDoc","NewInvoiceSubmit","alertUnsavedChanges","getInputValueByLabel","date_YYYY_MM","date_DD_MM_YYYY","v4","uuidv4","NewInvoice","constructor","props","state","invoice","handleChanges","bind","resestInvoiceState","invoive_init_state","_id","created_at","Date","saved_as","issue_date","due_date","bg_color","localStorage","invoice_bg","text_color","invoice_txt","profile","JSON","parse","stringify","details","company","tasks","discount","tax","fees","notes","currency","componentDidMount","setState","tabs","window","location","search","invoiceInitState","session","newInvoiceLoaded","noTasksIncluded","map","t","addToInvoice","company_abbr","split","length","el","toUpperCase","join","slice","invoices_num","invoices","String","TWO_WEEKS","getTime","searchArr","invoice_ID","invoiceToLoad","find","tasksArrIncInvoiceTasks","componentWillUnmount","authenticated","console","log","filter","history","render","propTypes","object","func","mapStateToProps","companies","c","currentCompany","mapDispatchToProps"],"mappings":";AAAA,OAAOA,KAAP,IAAgBC,SAAhB,QAAiC,OAAjC;AACA,OAAOC,SAAP,MAAsB,YAAtB;AACA,SAASC,UAAT,QAA2B,kBAA3B;AACA,SAASC,OAAT,QAAwB,aAAxB;AACA,SAASC,mBAAT,QAAoC,gCAApC;AACA,SAASC,gBAAT,QAAiC,kCAAjC;AACA,OAAOC,UAAP,MAAuB,yBAAvB;AACA,OAAOC,gBAAP,MAA6B,oBAA7B;AACA,SAASC,mBAAT,QAAoC,qDAApC;AACA,SAASC,oBAAT,QAAqC,kDAArC;AACA,SACIC,YADJ,EAEIC,eAFJ,QAGO,oCAHP;AAIA,SAASC,EAAE,IAAIC,MAAf,QAA6B,MAA7B;;AAEA,MAAMC,UAAN,SAAyBd,SAAzB,CAAmC;AAC/Be,EAAAA,WAAW,CAACC,KAAD,EAAQ;AACf,UAAMA,KAAN;AACA,SAAKC,KAAL,GAAa;AACTC,MAAAA,OAAO,EAAE;AADA,KAAb;AAGA,SAAKC,aAAL,GAAqB,KAAKA,aAAL,CAAmBC,IAAnB,CAAwB,IAAxB,CAArB;AACA,SAAKC,kBAAL,GAA0B,KAAKA,kBAAL,CAAwBD,IAAxB,CAA6B,IAA7B,CAA1B;AACH;;AAEDC,EAAAA,kBAAkB,GAAG;AACjB,UAAMC,kBAAkB,GAAG;AACvBC,MAAAA,GAAG,EAAE,IADkB;AAEvBC,MAAAA,UAAU,EAAE,IAAIC,IAAJ,EAFW;AAGvBC,MAAAA,QAHuB;AAIvBC,MAAAA,UAAU,EAAEhB,eAAe,CAAC,IAAIc,IAAJ,EAAD,CAJJ;AAKvBG,MAAAA,QALuB;AAMvBC,MAAAA,QAAQ,EAAEC,YAAY,CAACC,UAAb,IAA2B,MANd;AAOvBC,MAAAA,UAAU,EAAEF,YAAY,CAACG,WAAb,IAA4B,OAPjB;AAQvBC,MAAAA,OAAO,EAAEC,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAe,KAAKrB,KAAL,CAAWkB,OAAX,CAAmBI,OAAlC,CAAX,CARc;AASvBC,MAAAA,OAAO,EAAEJ,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAe,KAAKrB,KAAL,CAAWuB,OAAX,CAAmBD,OAAlC,CAAX,CATc;AAUvBE,MAAAA,KAAK,EAAE,EAVgB;AAWvBC,MAAAA,QAAQ,EAAE,CAXa;AAYvBC,MAAAA,GAAG,EAAE,CAZkB;AAavBC,MAAAA,IAAI,EAAE,CAbiB;AAcvBC,MAAAA,KAAK,EAAE,8BAdgB;AAevBC,MAAAA,QAAQ,EAAE;AAfa,KAA3B,CADiB,CAkBjB;AACA;AACH;;AACDC,EAAAA,iBAAiB,GAAG;AAChB;AACA,SAAKC,QAAL,CAAc,EAAE,GAAG,KAAK9B,KAAV;AAAiB+B,MAAAA,IAAI,EAAEC,MAAM,CAACC,QAAP,CAAgBC;AAAvC,KAAd;AACA,QAAIC,gBAAJ;;AACA,QAAI,KAAKpC,KAAL,CAAWqC,OAAX,CAAmBC,gBAAvB,EAAyC;AACrC;AACA,YAAMC,eAAe,GAAG,KAAKvC,KAAL,CAAWuB,OAAX,CAAmBC,KAAnB,CAAyBgB,GAAzB,CACnBC,CAAD,IAAQA,CAAC,CAACC,YAAF,GAAiB,KADL,CAAxB;AAGArD,MAAAA,gBAAgB,CAAC,OAAD,EAAUkD,eAAV,EAA2B,KAAKvC,KAAL,CAAWuB,OAAX,CAAmBhB,GAA9C,CAAhB,CALqC,CAMrC;;AACA,UAAIoC,YAAY,GAAGlD,oBAAoB,CACnC,KAAKO,KAAL,CAAWuB,OAAX,CAAmBD,OADgB,EAEnC,MAFmC,CAApB,CAGjBsB,KAHiB,CAGX,GAHW,CAAnB;;AAIA,UAAID,YAAY,CAACE,MAAb,GAAsB,CAAtB,IAA2BF,YAAY,CAAC,CAAD,CAA3C,EAAgD;AAC5CA,QAAAA,YAAY,GAAGA,YAAY,CACtBH,GADU,CACLM,EAAD,IAAQA,EAAE,CAAC,CAAD,CAAF,CAAMC,WAAN,EADF,EAEVC,IAFU,CAEL,EAFK,CAAf;AAGH,OAJD,MAIO;AACHL,QAAAA,YAAY,GAAGA,YAAY,CAAC,CAAD,CAAZ,CAAgBM,KAAhB,CAAsB,CAAtB,EAAyB,CAAzB,EAA4BF,WAA5B,EAAf;AACH;;AACD,UAAIG,YAAY,GAAG,GAAnB;AACA,UAAI,KAAKlD,KAAL,CAAWuB,OAAX,CAAmB4B,QAAvB,EACID,YAAY,GAAGE,MAAM,CAAC,KAAKpD,KAAL,CAAWuB,OAAX,CAAmB4B,QAAnB,CAA4BN,MAA5B,GAAqC,CAAtC,CAArB;;AACJ,aAAOK,YAAY,CAACL,MAAb,GAAsB,CAA7B,EAAgC;AAC5BK,QAAAA,YAAY,GAAG,MAAMA,YAArB;AACH;;AACD,UAAIxC,QAAQ,GAAGiC,YAAY,GAAG,GAA9B;AACAjC,MAAAA,QAAQ,IAAIhB,YAAY,CAAC,IAAIe,IAAJ,EAAD,CAAZ,GAA2B,GAAvC;AACAC,MAAAA,QAAQ,IAAIwC,YAAZ,CA1BqC,CA2BrC;;AACA,YAAMG,SAAS,GAAG,MAAlB;AACA,UAAIzC,QAAQ,GAAGjB,eAAe,CAAC,IAAIc,IAAJ,GAAW6C,OAAX,KAAuBD,SAAxB,CAA9B,CA7BqC,CA8BrC;;AACAjB,MAAAA,gBAAgB,GAAG;AACf7B,QAAAA,GAAG,EAAEV,MAAM,EADI;AAEfW,QAAAA,UAAU,EAAE,IAAIC,IAAJ,EAFG;AAGfC,QAAAA,QAHe;AAIfC,QAAAA,UAAU,EAAEhB,eAAe,CAAC,IAAIc,IAAJ,EAAD,CAJZ;AAKfG,QAAAA,QALe;AAMfC,QAAAA,QAAQ,EAAEC,YAAY,CAACC,UAAb,IAA2B,MANtB;AAOfC,QAAAA,UAAU,EAAEF,YAAY,CAACG,WAAb,IAA4B,OAPzB;AAQfC,QAAAA,OAAO,EAAEC,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAe,KAAKrB,KAAL,CAAWkB,OAAX,CAAmBI,OAAlC,CAAX,CARM;AASfC,QAAAA,OAAO,EAAEJ,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAe,KAAKrB,KAAL,CAAWuB,OAAX,CAAmBD,OAAlC,CAAX,CATM;AAUfE,QAAAA,KAAK,EAAE,EAVQ;AAWfC,QAAAA,QAAQ,EAAE,CAXK;AAYfC,QAAAA,GAAG,EAAE,CAZU;AAafC,QAAAA,IAAI,EAAE,CAbS;AAcfC,QAAAA,KAAK,EAAE,8BAdQ;AAefC,QAAAA,QAAQ,EAAE;AAfK,OAAnB,CA/BqC,CAgDrC;;AACA,WAAKE,QAAL,CAAc;AACV7B,QAAAA,OAAO,EAAEiB,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAee,gBAAf,CAAX;AADC,OAAd,EAjDqC,CAqDrC;;AACA,WAAKpC,KAAL,CAAWZ,mBAAX,CAA+BgD,gBAA/B;AACH;;AAED,UAAMmB,SAAS,GAAGtB,MAAM,CAACC,QAAP,CAAgBC,MAAhB,CAAuBS,KAAvB,CAA6B,GAA7B,CAAlB;;AACA,QAAIW,SAAS,CAAC,CAAD,CAAb,EAAkB;AACd;AACA;AACA;AACA;AACA,YAAMC,UAAU,GAAGD,SAAS,CAAC,CAAD,CAAT,CAAaN,KAAb,CAAmB,CAAnB,CAAnB;AACA,YAAMQ,aAAa,GAAG,KAAKzD,KAAL,CAAWuB,OAAX,CAAmB4B,QAAnB,CAA4BO,IAA5B,CACjBxD,OAAD,IAAaA,OAAO,CAACK,GAAR,KAAgBiD,UADX,CAAtB;;AAGA,UAAIC,aAAJ,EAAmB;AACf;AACArB,QAAAA,gBAAgB,GAAGqB,aAAnB,CAFe,CAGf;;AACA,cAAME,uBAAuB,GAAG,CAC5B,GAAGF,aAAa,CAACjC,KADW,EAE5B,GAAG,KAAKxB,KAAL,CAAWuB,OAAX,CAAmBC,KAFM,CAAhC;AAIA,aAAKxB,KAAL,CAAWX,gBAAX,CACI,OADJ,EAEIsE,uBAFJ,EAGI,KAAK3D,KAAL,CAAWuB,OAAX,CAAmBhB,GAHvB;AAKH;AACJ;AACJ;;AACDqD,EAAAA,oBAAoB,GAAG;AACnB;AACA,QAAI,KAAK5D,KAAL,CAAWqC,OAAX,CAAmBwB,aAAvB,EAAsC,KAAK1D,aAAL;AACzC;;AACDA,EAAAA,aAAa,GAAG;AACZ;AACA2D,IAAAA,OAAO,CAACC,GAAR,CACI5C,IAAI,CAACE,SAAL,CAAe,KAAKpB,KAAL,CAAWC,OAA1B,MACIiB,IAAI,CAACE,SAAL,CAAe,KAAKrB,KAAL,CAAWE,OAA1B,CAFR;AAIA,SAAKF,KAAL,CAAWE,OAAX,CAAmBsB,KAAnB,GAA2B,KAAKxB,KAAL,CAAWuB,OAAX,CAAmBC,KAAnB,CAAyBwC,MAAzB,CACtBvB,CAAD,IAAOA,CAAC,CAACC,YADc,CAA3B;AAGAoB,IAAAA,OAAO,CAACC,GAAR,CAAY,KAAK9D,KAAL,CAAWC,OAAvB,EAAgC,KAAKF,KAAL,CAAWE,OAA3C;AAEAV,IAAAA,mBAAmB,CACf,KAAKS,KAAL,CAAWC,OADI,EAEf,KAAKF,KAAL,CAAWE,OAFI,EAGd,wBAAuB,KAAKF,KAAL,CAAWuB,OAAX,CAAmBhB,GAAI,GAAE,KAAKN,KAAL,CAAW+B,IAAK,EAHlD,EAIf,IAJe,EAKf,KAAKhC,KAAL,CAAWiE,OALI,CAAnB,CAXY,CAkBZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACH;;AACDC,EAAAA,MAAM,GAAG;AACL,wBACI;AAAS,MAAA,SAAS,EAAC,iBAAnB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBACI;AAAI,MAAA,SAAS,EAAC,SAAd;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BADJ,eAEI,oBAAC,UAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAFJ,eAGI,oBAAC,gBAAD;AAAkB,MAAA,gBAAgB,EAAE,KAAKjE,KAAL,CAAWC,OAA/C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAHJ,CADJ;AAOH;;AAjL8B;;AAoLnCJ,UAAU,CAACqE,SAAX,GAAuB;AACnB9B,EAAAA,OAAO,EAAEpD,SAAS,CAACmF,MADA;AAEnBlD,EAAAA,OAAO,EAAEjC,SAAS,CAACmF,MAFA;AAGnB7C,EAAAA,OAAO,EAAEtC,SAAS,CAACmF,MAHA;AAInBlE,EAAAA,OAAO,EAAEjB,SAAS,CAACmF,MAJA;AAKnB/E,EAAAA,gBAAgB,EAAEJ,SAAS,CAACoF;AALT,CAAvB;;AAQA,MAAMC,eAAe,GAAIrE,KAAD,KAAY;AAChCoC,EAAAA,OAAO,EAAEpC,KAAK,CAACoC,OADiB;AAEhCnB,EAAAA,OAAO,EAAEjB,KAAK,CAACiB,OAFiB;AAGhCK,EAAAA,OAAO,EAAEtB,KAAK,CAACsE,SAAN,CAAgBb,IAAhB,CACJc,CAAD,IAAOA,CAAC,CAACjE,GAAF,KAAUN,KAAK,CAACoC,OAAN,CAAcoC,cAD1B,CAHuB;AAMhCvE,EAAAA,OAAO,EAAED,KAAK,CAACC;AANiB,CAAZ,CAAxB;;AASA,MAAMwE,kBAAkB,GAAG;AACvBtF,EAAAA,mBADuB;AAEvBC,EAAAA;AAFuB,CAA3B;AAKA,eAAeF,OAAO,CAClBmF,eADkB,EAElBI,kBAFkB,CAAP,CAGbxF,UAAU,CAACY,UAAD,CAHG,CAAf","sourcesContent":["import React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport { withRouter } from 'react-router-dom';\nimport { connect } from 'react-redux';\nimport { setInvoiceInitState } from '../../../redux/actions/invoice';\nimport { updateCompanyArr } from '../../../redux/actions/companies';\nimport InvoiceDoc from './invoiceDoc/InvoiceDoc';\nimport NewInvoiceSubmit from './NewInvoiceSubmit';\nimport { alertUnsavedChanges } from '../../../components/form/utils/handleUnsavedChanges';\nimport { getInputValueByLabel } from '../../../components/form/utils/customFormQueries';\nimport {\n    date_YYYY_MM,\n    date_DD_MM_YYYY,\n} from '../../../components/calendar/dates';\nimport { v4 as uuidv4 } from 'uuid';\n\nclass NewInvoice extends Component {\n    constructor(props) {\n        super(props);\n        this.state = {\n            invoice: null,\n        };\n        this.handleChanges = this.handleChanges.bind(this);\n        this.resestInvoiceState = this.resestInvoiceState.bind(this);\n    }\n\n    resestInvoiceState() {\n        const invoive_init_state = {\n            _id: null,\n            created_at: new Date(),\n            saved_as,\n            issue_date: date_DD_MM_YYYY(new Date()),\n            due_date,\n            bg_color: localStorage.invoice_bg || 'blue',\n            text_color: localStorage.invoice_txt || 'white',\n            profile: JSON.parse(JSON.stringify(this.props.profile.details)),\n            company: JSON.parse(JSON.stringify(this.props.company.details)),\n            tasks: [],\n            discount: 0,\n            tax: 0,\n            fees: 0,\n            notes: 'Thank you for your business.',\n            currency: '',\n        };\n        //on submit clear app updates\n        // this.props.setUpdates(null);\n    }\n    componentDidMount() {\n        //set current tabs for handling unsaved changes redirection\n        this.setState({ ...this.state, tabs: window.location.search });\n        let invoiceInitState;\n        if (this.props.session.newInvoiceLoaded) {\n            //set all tasks to be excluded from invoice on load of a new invoice\n            const noTasksIncluded = this.props.company.tasks.map(\n                (t) => (t.addToInvoice = false)\n            );\n            updateCompanyArr('tasks', noTasksIncluded, this.props.company._id);\n            //invoice num #\n            let company_abbr = getInputValueByLabel(\n                this.props.company.details,\n                'Name'\n            ).split(' ');\n            if (company_abbr.length > 1 && company_abbr[1]) {\n                company_abbr = company_abbr\n                    .map((el) => el[0].toUpperCase())\n                    .join('');\n            } else {\n                company_abbr = company_abbr[0].slice(0, 3).toUpperCase();\n            }\n            let invoices_num = '1';\n            if (this.props.company.invoices)\n                invoices_num = String(this.props.company.invoices.length + 1);\n            while (invoices_num.length < 5) {\n                invoices_num = '0' + invoices_num;\n            }\n            let saved_as = company_abbr + '-';\n            saved_as += date_YYYY_MM(new Date()) + '-';\n            saved_as += invoices_num;\n            //generate due date in 14 days\n            const TWO_WEEKS = 1.21e9;\n            let due_date = date_DD_MM_YYYY(new Date().getTime() + TWO_WEEKS);\n            //a new invoice\n            invoiceInitState = {\n                _id: uuidv4(),\n                created_at: new Date(),\n                saved_as,\n                issue_date: date_DD_MM_YYYY(new Date()),\n                due_date,\n                bg_color: localStorage.invoice_bg || 'blue',\n                text_color: localStorage.invoice_txt || 'white',\n                profile: JSON.parse(JSON.stringify(this.props.profile.details)),\n                company: JSON.parse(JSON.stringify(this.props.company.details)),\n                tasks: [],\n                discount: 0,\n                tax: 0,\n                fees: 0,\n                notes: 'Thank you for your business.',\n                currency: '',\n            };\n            //set init state for comparison on component unmounting\n            this.setState({\n                invoice: JSON.parse(JSON.stringify(invoiceInitState)),\n            });\n\n            //set redux state\n            this.props.setInvoiceInitState(invoiceInitState);\n        }\n\n        const searchArr = window.location.search.split('&');\n        if (searchArr[1]) {\n            //updating an existing invoice\n            //?updating=...\n            //downlaoding an existing invoice\n            //?download=...\n            const invoice_ID = searchArr[1].slice(9);\n            const invoiceToLoad = this.props.company.invoices.find(\n                (invoice) => invoice._id === invoice_ID\n            );\n            if (invoiceToLoad) {\n                //invoiceInitState from the invoices arr\n                invoiceInitState = invoiceToLoad;\n                //add invoice tasks to existing tasks of the current company\n                const tasksArrIncInvoiceTasks = [\n                    ...invoiceToLoad.tasks,\n                    ...this.props.company.tasks,\n                ];\n                this.props.updateCompanyArr(\n                    'tasks',\n                    tasksArrIncInvoiceTasks,\n                    this.props.company._id\n                );\n            }\n        }\n    }\n    componentWillUnmount() {\n        //auth err and logout won't trigger fun\n        if (this.props.session.authenticated) this.handleChanges();\n    }\n    handleChanges() {\n        //TASKS CAN BE AMENDED/UPDATED IN FORM  WITH EFECT ON DB HENCE NEED TO CHECK INIT STATE AGAINST COMPANY.TASKS NOT INVOICE.TASKS!!!\n        console.log(\n            JSON.stringify(this.state.invoice) ===\n                JSON.stringify(this.props.invoice)\n        );\n        this.props.invoice.tasks = this.props.company.tasks.filter(\n            (t) => t.addToInvoice\n        );\n        console.log(this.state.invoice, this.props.invoice);\n\n        alertUnsavedChanges(\n            this.state.invoice,\n            this.props.invoice,\n            `/dashboard/companies/${this.props.company._id}${this.state.tabs}`,\n            null,\n            this.props.history\n        );\n        // if (\n        //     JSON.stringify(this.state.invoice) !==\n        //     JSON.stringify(this.props.invoice)\n        // ) {\n        //     const msg = `You have some unsaved changes. What would you like to do?`;\n        //     const cancelBtnText = 'Discharge changes';\n        //     const confirmBtnText = 'Return to the form!';\n        //     const confirmCb = () => {};\n        //     const cancelCb = async () => {};\n        //     dialogBox({\n        //         msg,\n        //         cancelBtnText,\n        //         confirmBtnText,\n        //         confirmCb,\n        //         cancelCb,\n        //     });\n        // } else {\n        //     //remove any tasks added on update\n        //     const tasksWithoutInvocieTasks = this.props.company.tasks.filter(\n        //         (el) => !this.state.invoice.tasks.includes(el)\n        //     );\n        //     console.log(tasksWithoutInvocieTasks);\n        //     this.props.updateCompanyArr(\n        //         'tasks',\n        //         tasksWithoutInvocieTasks,\n        //         this.props.company._id\n        //     );\n        // }\n    }\n    render() {\n        return (\n            <section className='company-invoice'>\n                <h2 className='sr-only'>Create a new invoice.</h2>\n                <InvoiceDoc />\n                <NewInvoiceSubmit invoiceInitState={this.state.invoice} />\n            </section>\n        );\n    }\n}\n\nNewInvoice.propTypes = {\n    session: PropTypes.object,\n    profile: PropTypes.object,\n    company: PropTypes.object,\n    invoice: PropTypes.object,\n    updateCompanyArr: PropTypes.func,\n};\n\nconst mapStateToProps = (state) => ({\n    session: state.session,\n    profile: state.profile,\n    company: state.companies.find(\n        (c) => c._id === state.session.currentCompany\n    ),\n    invoice: state.invoice,\n});\n\nconst mapDispatchToProps = {\n    setInvoiceInitState,\n    updateCompanyArr,\n};\n\nexport default connect(\n    mapStateToProps,\n    mapDispatchToProps\n)(withRouter(NewInvoice));\n"]},"metadata":{},"sourceType":"module"}